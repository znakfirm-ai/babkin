generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum WorkspaceType {
  personal
  family
}

enum WorkspaceRole {
  owner
  admin
  member
  viewer
}

enum TransactionKind {
  income
  expense
  transfer
}

model income_sources {
  id           String   @id @default(uuid())
  workspace_id String
  name         String
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  workspace workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  transactions transactions[]

  @@index([workspace_id])
}

model users {
  id                  String    @id @default(uuid())
  telegram_user_id    String    @unique
  first_name          String?
  username            String?
  active_workspace_id String?

  workspaces_users_active_workspace_idTousers workspaces? @relation("users_active_workspace_id", fields: [active_workspace_id], references: [id])
  workspaces                                  workspaces[] @relation("workspaces_created_by_user_id")
  workspace_members                           workspace_members[]
  workspace_invites                           workspace_invites[] @relation("workspace_invites_created_by_user_id")

  @@index([telegram_user_id])
}

model workspaces {
  id                 String             @id @default(uuid())
  type               WorkspaceType
  name               String?
  created_by_user_id String
  created_at         DateTime           @default(now())

  users_workspaces_created_by_user_idTousers users           @relation("workspaces_created_by_user_id", fields: [created_by_user_id], references: [id])
  active_for_users                           users[]         @relation("users_active_workspace_id")
  workspace_members                          workspace_members[]
  workspace_invites                          workspace_invites[] @relation("workspace_invites_workspace_id")
  accounts                                   accounts[]
  categories                                 categories[]
  transactions                               transactions[]
  income_sources                             income_sources[]

  @@index([created_by_user_id])
}

model workspace_members {
  workspace_id String
  user_id      String
  role         WorkspaceRole

  workspaces workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  users      users      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([workspace_id, user_id])
  @@index([user_id])
}

model workspace_invites {
  id                String   @id @default(uuid())
  workspace_id      String
  code              String   @unique
  created_by_user_id String
  expires_at        DateTime?
  max_uses          Int?
  uses_count        Int      @default(0)
  is_revoked        Boolean  @default(false)
  created_at        DateTime @default(now())

  workspaces workspaces @relation("workspace_invites_workspace_id", fields: [workspace_id], references: [id], onDelete: Cascade)
  users      users      @relation("workspace_invites_created_by_user_id", fields: [created_by_user_id], references: [id], onDelete: Cascade)

  @@index([workspace_id])
  @@index([created_by_user_id])
}

model accounts {
  id           String   @id @default(uuid())
  workspace_id String
  name         String
  type         String
  currency     String
  balance      Decimal  @default(0)
  is_archived  Boolean  @default(false)
  archived_at  DateTime?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  workspace workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  transactions_account transactions[] @relation("transactions_account")
  transactions_from    transactions[] @relation("transactions_from_account")
  transactions_to      transactions[] @relation("transactions_to_account")

  @@index([workspace_id])
}

model categories {
  id           String   @id @default(uuid())
  workspace_id String
  name         String
  kind         CategoryKind
  icon         String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  workspace workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  transactions transactions[]

  @@index([workspace_id])
}

model transactions {
  id              String           @id @default(uuid())
  workspace_id    String
  kind            TransactionKind
  amount          Decimal      @db.Decimal(18, 2)
  happened_at     DateTime        @default(now())
  note            String?
  account_id      String?
  category_id     String?
  from_account_id String?
  to_account_id   String?
  income_source_id String?

  workspace workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  account   accounts?  @relation("transactions_account", fields: [account_id], references: [id])
  category  categories? @relation(fields: [category_id], references: [id])
  from_account accounts? @relation("transactions_from_account", fields: [from_account_id], references: [id])
  to_account   accounts? @relation("transactions_to_account", fields: [to_account_id], references: [id])
  income_source income_sources? @relation(fields: [income_source_id], references: [id])

  @@index([workspace_id])
  @@index([account_id])
  @@index([category_id])
  @@index([from_account_id])
  @@index([to_account_id])
  @@index([income_source_id])
}

enum CategoryKind {
  income
  expense
}
